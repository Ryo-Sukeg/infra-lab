# DNS Server 構築手順記録

## 構成概要
| 項 目 | 内 容 |
|------|------|
| DNS | Master : CentOS Stream 9（192.168.56.101）/ Slave : Ubuntu 24.04.3（192.168.56.102）|
| ドメイン | lab.lan |
| サービス / Version | BIND / 9.16.23-RH (Extended Support Version) |
| 役割 | 内部向け正引き・逆引きDNSサーバ |
| クライアント | RHEL 9.6 / AlmaLinux 9.6 |
---

## 手順
### 1. マスターDNSサーバ構築 (CentOS Stream 9)  
1-1. BINDインストール
```
sudo dnf install -y bind bind-utils
```
1-2. 設定ファイル編集 /etc/named.conf
```
sudo vi /etc/named.conf
```
以下のように編集（変更・追記部分のみ抜粋）：
```
options {
    listen-on port 53 { 127.0.0.1; 192.168.56.101; };   // どのNICでDNSを受けるか
    allow-query     { localhost; 192.168.56.0/24; };    // どのクライアントからの問い合わせを許可するか
    recursion yes;    // 自己解決できないドメインを外部に聞きに行くか

    forwarders { 8.8.8.8; 1.1.1.1; };    // recursion yes 時に問合わせる外部DNS
    forward only;

    directory "/var/named";
};

// ↓ このDNSサーバが管理するドメインや逆引きゾーンを定義
zone "lab.lan" IN {
    type master;
    file "lab.lan.zone";
    allow-transfer { 192.168.56.102; };    // 転送を許可する slave DNS
};

zone "56.168.192.in-addr.arpa" IN {
    type master;
    file "56.168.192.zone";
    allow-transfer { 192.168.56.102; };
};
```
1-3. ゾーンファイル作成
```
sudo vi /var/named/lab.lan.zone
```
内容：
```
$TTL 86400
@   IN  SOA     dns.lab.lan. root.lab.lan. (
        2025100601 ; Serial（変更ごとに+1）
        3600       ; Refresh
        1800       ; Retry
        604800     ; Expire
        86400 )    ; Minimum TTL

@       IN  NS      dns.lab.lan.
dns     IN  A       192.168.56.101
stream  IN  A       192.168.56.101
ubuntu  IN  A       192.168.56.102
rhel    IN  A       192.168.56.103
alma    IN  A       192.168.56.104
```
逆引きゾーン：    ※ IPアドレス → ホスト名 の変換
```
sudo vi /var/named/56.168.192.zone
```
内容：
```
$TTL 86400
$TTL 86400
@   IN  SOA     dns.lab.lan. root.lab.lan. (
        2025100501
        3600
        1800
        604800
        86400 )

@       IN  NS      dns.lab.lan.
101     IN  PTR     stream.lab.lan.
102     IN  PTR     ubuntu.lab.lan.
103     IN  PTR     rhel.lab.lan.
104     IN  PTR     alma.lab.lan.
```
1-4. firewalld・SELinux設定
```
sudo firewall-cmd --permanent --add-service=dns
sudo firewall-cmd --reload
sudo setsebool -P named_write_master_zones on
```
1-5. サービス起動と動作確認
```
sudo systemctl enable --now named
sudo systemctl status named
sudo named-checkconf
sudo named-checkzone lab.lan /var/named/lab.lan.zone
sudo named-checkzone 56.168.192.in-addr.arpa /var/named/56.168.192.zone
```
### 2. スレーブDNSサーバ構築 (Ubuntu 24.04.3)
2-1. BINDインストール
```
sudo apt install -y bind9 bind9-utils
```
2-2. 設定ファイル編集 /etc/bind/named.conf.local
```
zone "lab.lan" {
    type slave;
    masters { 192.168.56.101; };
    file "/var/cache/bind/lab.lan.zone";
};

zone "56.168.192.in-addr.arpa" {
    type slave;
    masters { 192.168.56.101; };
    file "/var/cache/bind/56.168.192.in-addr.arpa.zone";
};
```
2-3. 起動・確認
```
sudo systemctl enable --now bind9
sudo systemctl status bind9
ls -l /var/cache/bind/    // 成功していれば lab.lan.zone や 56.168.192.in-addr.arpa.zone が生成されているはず
```
→ ゾーンファイルが自動転送されていれば成功  
※ なければプライマリ側のログ確認 `sudo journalctl -u named -f`
### 3. クライアント設定 (RHEL/Alma)
3-1. 参照するDNSサーバの指定　※ nmtui コマンドでも可
```
sudo nmcli device    // インタフェース名・種別・状態・接続を表示
sudo nmcli connection modify IF名 ipv4.dns "192.168.56.101 192.168.56.102 8.8.8.8"    // DNS追加、8.8.8.8 は Google
sudo nmcli connection modify IF名 ipv4.ignore-auto-dns yes    // DHCPからDNSを自動取得するのを無効にする
sudo systemctl restart NetworkManager    // 設定反映
cat /etc/resolv.conf    // 変更反映を確認
```
3-2. 動作確認
```
dig ubuntu.lab.lan
dig -x 192.168.56.101
dig @192.168.56.102 alma.lab.lan    // @+問合わせ先サーバ+ 問合せたいドメイン名（IPは-xオプション使用）
dig @192.168.56.102 -x 192.168.56.104
```
クライアント側で dig コマンドが使えない場合は以下をインストール
```
sudo dnf install -y bind-utils
```
### 4. 備考
- 両DNSが正引き・逆引きともに応答することを確認
- Serial 番号を上げるとスレーブへ自動転送される、番号は通常 日付（年、月、日）と 連番（nn）で構成される
- BINDのゾーン定義は /etc/named.conf か /etc/bind/named.conf.local に分けると分かりやすい
- ファイアウォールはUDP/TCPの53番ポートを許可
- 設定変更後は反映させるため BIND の再起動が必要（RedHat : systemctl restart named / Debian : systemctl restart bind9）
- スレーブが同期しない場合は /var/log/messages か /var/log/syslog を確認
- mDNS警告 `WARNING: .local is reserved for Multicast DNS`：.local は Apple系の Bonjour（mDNS）で使われる予約ドメインで普通のDNSでも使えるけど毎回この警告が出るとのこと。回避するにはドメイン名に .local を使用しない  
### エラー関連
- 再起動後にDNS解決が出来ない：/etc/resolv.conf の内容が書き換わっていないか確認、ファイル一行目に `Generated by NetworkManager` と記載があり nameserver の値が変わっている場合は再起動時にファイルが NetworkManager によって書き換えられているので、DNSサーバは nmcli か nmtui コマンドで指定し # systemctl restart NetworkManager で NetworkManager を再起動する
- digコマンドが内部DNSではなく外部DNSを参照している：IFのDNS設定で外部DNS（8.8.8.8とか）の指定順を確認（nmcli や nmtui など）、指定している場合は順番を後に変えるか削除して NetworkManager を再起動する
### 気になったコマンド
BINDのバージョン確認
```
named -v
dnf info bind
```
レコード種類を指定
```
dig alma.lab.lan MX
dig alma.lab.lan NS
dig alma.lab.lan SOA
```
詳細表示（+traceオプション）※ ルートからの解決経路を全部表示
```
dig +trace alma.lab.lan
```
